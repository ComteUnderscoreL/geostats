<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>No Move Challenges</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<main class="wrap">
  <h1>No Move Challenges</h1>

  <section class="card">
    <h2>Challenge en cours</h2>
    <div id="currentMeta" class="muted"></div>
    <a id="currentLink" class="btn" target="_blank" rel="noopener">Ouvrir le challenge</a>
  </section>

  <section class="card">
    <h2>Dernier challenge terminé</h2>
    <div id="lastMeta" class="muted"></div>
    <a id="lastLink" class="btn" target="_blank" rel="noopener">Ouvrir le challenge</a>
    <div id="lastLeaderboard"></div>
  </section>

  <section class="card">
    <h2>Historique</h2>
    <div id="history"></div>
  </section>
</main>

<script>
const BASE_URL = "https://www.geoguessr.com/challenge/";
const TOP_N = 10;

async function loadText(path) {
  const r = await fetch(path, { cache: "no-store" });
  if (!r.ok) return "";
  return (await r.text()).trim();
}

async function loadTSV(path) {
  const res = await fetch(path, { cache: "no-store" });
  if (!res.ok) throw new Error("Cannot load " + path);
  const text = await res.text();
  const lines = text.trim().split("\n");
  if (lines.length < 2) return [];
  const cols = lines[0].split("\t");
  return lines.slice(1).map(r => {
    const vals = r.split("\t");
    const o = {};
    cols.forEach((c,i) => o[c] = vals[i]);
    return o;
  });
}

function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function renderLeaderboard(rows) {
  return `
    <table>
      <thead><tr><th>#</th><th>Joueur</th><th class="num">Score</th></tr></thead>
      <tbody>
        ${rows.slice(0, TOP_N).map(r =>
          `<tr><td>${esc(r.position)}</td><td>${esc(r.player)}</td><td class="num">${esc(r.total_score)}</td></tr>`
        ).join("")}
      </tbody>
    </table>
  `;
}

function renderHistoryBlock(numero, rows) {
  const map = rows[0].map || "UNKNOWN_MAP";
  const cid = rows[0].challenge_id || "";
  const url = cid ? (BASE_URL + cid) : "#";

  return `
    <article class="subcard">
      <div class="row">
        <div class="title">#${esc(numero)} — ${esc(map)}</div>
        <a class="btn small" href="${esc(url)}" target="_blank" rel="noopener">Lien</a>
      </div>
      ${renderLeaderboard(rows)}
    </article>
  `;
}

(async () => {
  // Current challenge
  const currentId = await loadText("data/current.txt");
  if (currentId) {
    document.getElementById("currentMeta").textContent = "Challenge du jour";
    document.getElementById("currentLink").href = BASE_URL + currentId;
  } else {
    document.getElementById("currentMeta").textContent = "Aucun challenge en cours.";
    document.getElementById("currentLink").style.display = "none";
  }

  // Finished challenges
  const totals = await loadTSV("data/totals.tsv");
  if (!totals.length) return;

  const byNumero = {};
  for (const r of totals) {
    const n = Number(r.Numero);
    if (!Number.isFinite(n)) continue;
    (byNumero[n] ||= []).push(r);
  }

  const numeros = Object.keys(byNumero).map(Number).sort((a,b)=>b-a);
  const last = numeros[0];

  for (const n of numeros) {
    byNumero[n].sort((a,b)=>Number(a.position) - Number(b.position));
  }

  const lastRows = byNumero[last];
  document.getElementById("lastMeta").textContent =
    `Challenge #${last} — ${lastRows[0].map || "UNKNOWN_MAP"}`;
  document.getElementById("lastLink").href =
    BASE_URL + (lastRows[0].challenge_id || "");
  document.getElementById("lastLeaderboard").innerHTML =
    renderLeaderboard(lastRows);

  const rest = numeros.slice(1);
  document.getElementById("history").innerHTML =
    rest.length
      ? rest.map(n => renderHistoryBlock(n, byNumero[n])).join("")
      : '<div class="muted">Pas encore d’historique.</div>';
})();
</script>
</body>
</html>
